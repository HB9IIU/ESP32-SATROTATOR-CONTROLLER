<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Satellite Tracker</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">



  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0d1117;
      color: #c9d1d9;
      margin: 0;
      padding: 1rem;
    }
  
    h1 {
      text-align: center;
      color: #f6cb3e;
    }
  
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 2rem;
    }
  
    th, td {
      padding: 0.5rem;
      border-bottom: 1px solid #30363d;
      text-align: center;
    }
  
    th {
      background-color: #161b22;
    }
  
    td.left {
      text-align: left;
    }
  
    .section {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
  
    .card {
      background-color: #161b22;
      padding: 1rem;
      margin: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      width: 300px;
    }
  
    .label {
      font-weight: bold;
      color: #f6cb3e;
      margin-bottom: 0.5rem;
    }
  
    .radio {
      float: right;

    }
  
    .highlight {
      background-color: #161b22;
      margin-top: 1rem;
      padding: 1rem;
      font-size: 1.5rem;
      text-align: center;
      color: #f6cb3e;
      border-radius: 0.5rem;
      border: 2px solid #30363d;
    }
  
    .above-horizon {
      color: #00ff88;
      font-weight: bold;
    }
  
    .hidden {
      display: none;
    }
  
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 1rem;
      margin-bottom: 2rem;
    }
  
    /* Big custom-styled radio buttons */
    input[type="radio"] {
      appearance: none;
      -webkit-appearance: none;
      width: 28px;
      height: 28px;
      border: 3px solid #f6cb3e;
      border-radius: 50%;
      background-color: transparent;
      outline: none;
      cursor: pointer;
      margin: 0.5rem;
  
      display: flex;
      align-items: center;
      justify-content: center;
    }
  
    input[type="radio"]::before {
      content: "";
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background-color: transparent;
      transition: background-color 0.2s ease;
    }
  
    input[type="radio"]:checked::before {
      background-color: #f6cb3e;
    }
  </style>
  






</head>
<body>
  <div id="headerTimeRow" class="header-row">
    <div id="utcTime" style="flex: 1; text-align: left; font-size: 1.8rem; font-weight: normal;color: #f6cb3e;">UTC: --:--:--</div>
    <div style="flex: 1; text-align: center;"><h1 style="margin: 0;">HB9IIU Rotator Controller</h1></div>
    <div id="localTime" style="flex: 1; text-align: right; font-size: 1.8rem; font-weight: normal;color: #f6cb3e;">Local: --:--:--</div>
  </div>
  

  <table id="satTable">
    <thead>
      <tr>
        <th>Select</th><th>Name</th><th>Azimuth</th><th>Elevation</th>
        <th>Freq (MHz)</th><th>Corrected Freq</th>
        <th>AOS</th><th>TCA</th><th>LOS</th>
        <th>Max El</th><th>Duration</th><th>Next Event</th>
      </tr>
    </thead>
    <tbody id="satBody"></tbody>
  </table>

  <div class="section">
    <div class="card">
      <div class="radio"><input type="radio" name="trackingTarget" value="sun"></div>
      <div class="label">ðŸŒž Sun</div>
      <table>
        <tr><td>Azimuth:</td><td id="sunAz">--Â°</td></tr>
        <tr><td>Elevation:</td><td id="sunEl">--Â°</td></tr>
        <tr><td>Sunrise:</td><td id="sunrise">--:--</td></tr>
        <tr><td>Sunset:</td><td id="sunset">--:--</td></tr>
      </table>
    </div>
    <div class="card">
      <div class="radio"><input type="radio" name="trackingTarget" value="moon"></div>
      <div class="label">ðŸŒ• Moon</div>
      <table>
        <tr><td>Azimuth:</td><td id="moonAz">--Â°</td></tr>
        <tr><td>Elevation:</td><td id="moonEl">--Â°</td></tr>
        <tr><td>Moonrise:</td><td id="moonrise">--:--</td></tr>
        <tr><td>Moonset:</td><td id="moonset">--:--</td></tr>
      </table>
    </div>
  </div>

  <div class="highlight" id="trackingBanner">ðŸ“¡ Currently Tracking:    </div>

  <div id="stopTrackingWrapper" class="hidden" style="text-align: center; margin-top: 1rem;">
    <button id="stopTrackingBtn" style="padding: 0.5rem 1rem; font-size: 1.1rem; background-color: #8b0000; color: white; border: none; border-radius: 5px; cursor: pointer;">
      ðŸš« Stop Tracking
    </button>
  </div>

  <script>
    let selectedTarget = null;
    const banner = document.getElementById("trackingBanner");
    const stopWrapper = document.getElementById("stopTrackingWrapper");

    const websocket = new WebSocket("ws://" + location.hostname + ":81");

    websocket.onopen = () => {
      console.log("âœ… WebSocket connected!");
      if (selectedTarget) websocket.send(JSON.stringify({ track: selectedTarget }));
    };

    websocket.onmessage = event => {
      try {
        const data = JSON.parse(event.data);
        console.log(data)
        if (!data.name || data.az === undefined || data.el === undefined) return;

        if (data.name.toLowerCase() === selectedTarget?.toLowerCase()) {
          console.log("here");
          banner.innerHTML = `ðŸ“¡ Currently Tracking: ${data.name} â€” Az: ${data.az.toFixed(1)}Â°, El: ${data.el.toFixed(1)}Â°`;
          stopWrapper.classList.remove("hidden");
        }
      } catch (e) {
        console.warn("â— WebSocket non-JSON message:", event.data);
      }
    };

    websocket.onclose = () => {
      console.warn("âš ï¸ WebSocket closed. Reconnecting in 2s...");
      setTimeout(() => location.reload(), 2000);
    };

    document.body.addEventListener("change", (e) => {
      if (e.target.name === "trackingTarget") {
        selectedTarget = e.target.value;
        if (websocket.readyState === WebSocket.OPEN) {
          websocket.send(JSON.stringify({ track: selectedTarget }));
        }
        banner.innerHTML = `ðŸ“¡ Currently Tracking: ${selectedTarget}`;
        stopWrapper.classList.remove("hidden");
      }
    });

    document.getElementById("stopTrackingBtn").addEventListener("click", () => {
      selectedTarget = null;
      document.querySelectorAll('input[name="trackingTarget"]').forEach(r => r.checked = false);
      if (websocket.readyState === WebSocket.OPEN) {
        websocket.send(JSON.stringify({ track: "" }));
      }
      banner.innerHTML = "ðŸ“¡ Currently Tracking: --";
      stopWrapper.classList.add("hidden");
    });

    async function loadSunMoonData() {
      const res = await fetch("/sunmoon");
      const data = await res.json();
      document.getElementById("sunAz").textContent = `${data.sunAzimuth.toFixed(1)}Â°`;
      document.getElementById("sunEl").textContent = `${data.sunElevation.toFixed(1)}Â°`;
      document.getElementById("sunrise").textContent = data.sunRiseLocal;
      document.getElementById("sunset").textContent = data.sunSetLocal;
      document.getElementById("moonAz").textContent = `${data.moonAzimuth.toFixed(1)}Â°`;
      document.getElementById("moonEl").textContent = `${data.moonElevation.toFixed(1)}Â°`;
      document.getElementById("moonrise").textContent = data.moonRiseLocal;
      document.getElementById("moonset").textContent = data.moonSetLocal;
    }

    async function loadSatelliteData() {
      const res = await fetch("/satellites");
      const data = await res.json();
      const tbody = document.getElementById("satBody");
      tbody.innerHTML = "";

      data.forEach(sat => {
        const row = document.createElement("tr");
        if (sat.elevation > 0) row.classList.add("above-horizon");

        row.innerHTML = `
          <td><input type="radio" name="trackingTarget" value="${sat.name}"></td>
          <td class="left">${sat.name}</td>
          <td>${sat.azimuth.toFixed(1)}Â°</td>
          <td>${sat.elevation.toFixed(1)}Â°</td>
          <td>${sat.frequencyMHz.toFixed(3)}</td>
          <td>${sat.correctedFreqMHz.toFixed(3)}</td>
          <td>${sat.aosLocal}</td>
          <td>${sat.tcaLocal}</td>
          <td>${sat.losLocal}</td>
          <td>${sat.maxElevation.toFixed(1)}</td>
          <td>${sat.passDuration}</td>
          <td>${sat.timeToEvent}</td>
        `;

        tbody.appendChild(row);
      });

      // âœ… Restore checked radio after refresh
      if (selectedTarget) {
        const radioToCheck = document.querySelector(`input[name="trackingTarget"][value="${selectedTarget}"]`);
        if (radioToCheck) radioToCheck.checked = true;
      }
    }
    // initial calls
    loadSunMoonData();
    loadSatelliteData();
    updateClocks();
    setInterval(() => {
      loadSunMoonData();
      loadSatelliteData();
      updateClocks();
    }, 1000);


    function updateClocks() {
  const now = new Date();
  const utcStr = now.toUTCString().split(" ")[4]; // HH:MM:SS
  const localStr = now.toLocaleTimeString('en-GB', { hour12: false }); // 24h format

  document.getElementById("utcTime").textContent = `UTC: ${utcStr}`;
  document.getElementById("localTime").textContent = `Local: ${localStr}`;
}









  </script>
</body>
</html>
